document.addEventListener("alpine:init",()=>{Alpine.data("grapesjs",({state:n,statePath:c,readOnly:f,tools:o,minHeight:d,container:i})=>({instance:null,state:n,tools:o,init(){this.instance=grapesjs.init({height:d+"px",container:i||".filament-grapesjs .grapesjs-wrapper",showOffsets:!0,fromElement:!0,noticeOnUnload:!1,storageManager:!1,loadHtml:n,panels:{defaults:[{buttons:[{attributes:{title:"Open Code"},className:"fa fa-code",command:"open-code",id:"open-code"}],id:"views"}]},plugins:["grapesjs-tailwind","grapesjs-preset-webpage","grapesjs-component-code-editor","grapesjs-custom-code"],assetManager:{upload:"/grapesjs/media",autoAdd:!0,assets:[],uploadFile:e=>{let a=e.dataTransfer?e.dataTransfer.files:e.target.files,s=new FormData;for(let t=0;t<a.length;t++)s.append("files[]",a[t]);fetch("/grapesjs/media",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:s}).then(t=>{if(!t.ok)throw new Error("Upload failed");return t.json()}).then(t=>{Array.isArray(t)?t.forEach(l=>{this.instance.AssetManager.add(l)}):this.instance.AssetManager.add([t])}).catch(t=>console.error("Error:",t))}}}),this.instance.Components.addType("non-editable",{model:{defaults:{editable:!1,draggable:!1,droppable:!1,copyable:!1,removable:!1,highlightable:!1,selectable:!1}},view:{events:{click:e=>e.stopPropagation(),dblclick:e=>e.stopPropagation(),mousedown:e=>e.stopPropagation()},onRender({el:e}){e.style.pointerEvents="none",e.style.opacity="0.8"}}});let r=()=>{this.instance.Components.getWrapper().find("*").forEach(a=>{if(a.getClasses().includes("gjs-non-editable")){a.set({type:"non-editable",editable:!1,draggable:!1,droppable:!1,copyable:!1,removable:!1,highlightable:!1,selectable:!1}),a.addAttributes({"data-gjs-locked":!0});let t=a.getEl();t&&(t.style.pointerEvents="none",t.style.opacity="0.8")}})};this.instance.on("load",r),this.instance.on("component:update",e=>{e.getClasses().includes("gjs-non-editable")&&e.set({editable:!1,draggable:!1,droppable:!1,copyable:!1,removable:!1,highlightable:!1,selectable:!1})}),this.instance.on("component:add",e=>{e.getClasses().includes("gjs-non-editable")&&e.set({type:"non-editable",editable:!1,draggable:!1,droppable:!1,copyable:!1,removable:!1,highlightable:!1,selectable:!1})}),fetch("/grapesjs/media").then(e=>{if(!e.ok)throw new Error("Failed to fetch assets");return e.json()}).then(e=>{Array.isArray(e)&&this.instance.AssetManager.add(e)}).catch(e=>console.error("Error:",e)),this.instance.on("update",e=>{var a=this.instance.getHtml({cleanId:!0}),s=a.match(/<body\b[^>]*>([\s\S]*?)<\/body>/),t=s?s[1]:a,l=t.replace(/<div[^>]*class=["'][^"']*gjs-non-editable[^"']*["'][^>]*>[\s\S]*?<\/div>/g,"");this.state=l.trim()}),this.instance.on("codeEdit:before",()=>{this._originalCodeViewHtml=this.instance.getHtml();let e=this.instance.getHtml();e=e.replace(/<div[^>]*class=["'][^"']*gjs-non-editable[^"']*["'][^>]*>[\s\S]*?<\/div>/g,""),this.instance.setCustomCode(e)}),this.instance.on("codeEdit:after",()=>{if(this._originalCodeViewHtml){let e=this.instance.getCustomCode();this._filteredCodeViewHtml===e&&this.instance.DomComponents.getWrapper().set("content",this._originalCodeViewHtml),this._originalCodeViewHtml=null,this._filteredCodeViewHtml=null}}),this.instance.Commands.add("open-code",{run:function(e,a){let s=e.getHtml();s=s.replace(/<div[^>]*class=["'][^"']*gjs-non-editable[^"']*["'][^>]*>[\s\S]*?<\/div>/g,""),e._filteredCodeViewHtml=s,e.Modal.open({title:"Code Editor",content:`<textarea style="width:100%; height:250px;">${s}</textarea>`,attributes:{class:"gjs-modal-code"}})}})}}))});
